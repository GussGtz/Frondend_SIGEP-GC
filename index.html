<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Pedidos</title>

  <link rel="icon" href="/assets/logoglassico.ico" type="image/png" />

  <!-- Fuentes / Iconos -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- jQuery + Bootstrap 4 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd">

  <!-- PWA / iOS -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SIGEP-GC">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">

  <style>
    .pinkBg{background-color:#ed184f!important;background-image:linear-gradient(90deg,#fd5581,#fd8b55)}
    .intro-banner-vdo-play-btn{height:40px;width:40px;position:relative;display:inline-block;text-align:center;border-radius:100px;z-index:1}
    .intro-banner-vdo-play-btn i{line-height:40px;font-size:20px;color:white}
    .intro-banner-vdo-play-btn .ripple{position:absolute;width:100px;height:100px;z-index:-1;left:50%;top:50%;opacity:0;margin:-50px 0 0 -50px;border-radius:100px;animation:ripple 1.8s infinite}
    @keyframes ripple{0%{opacity:1;transform:scale(0)}100%{opacity:0;transform:scale(1)}}
    .intro-banner-vdo-play-btn .ripple:nth-child(2){animation-delay:.3s}
    .intro-banner-vdo-play-btn .ripple:nth-child(3){animation-delay:.6s}

    *{box-sizing:border-box}
    body{background:url('/assets/fondo.png') center/cover no-repeat fixed;font-family:'Plus Jakarta Sans',sans-serif;margin:0;padding:0;color:#333;backdrop-filter:brightness(0.95)}
    .main-container{max-width:1400px;width:95%;margin:40px auto;padding:30px;background-color:rgba(255,255,255,.96);border-radius:1.5rem;box-shadow:0 0 40px rgba(0,0,0,.15)}
    .logo-container{text-align:center;margin-bottom:20px}
    .logo-container img{width:180px;filter:drop-shadow(0 0 8px rgba(0,0,0,.2))}
    h2,h3{text-align:center;font-weight:800;margin-bottom:25px;font-size:1.8rem;background:linear-gradient(to right,#0d6efd,#20c997);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    #logoutBtn{float:right;margin-bottom:10px;background-color:#dc3545;font-size:.95rem}

    form{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin-bottom:25px}
    input[type="text"],input[type="date"],select{padding:10px 12px;border-radius:.6rem;border:1px solid #ccc;min-width:180px;font-size:.95rem}
    input:focus,select:focus{border-color:#0d6efd;box-shadow:0 0 0 .25rem rgba(13,110,253,.2);outline:none}
    button{padding:10px 18px;background:linear-gradient(to right,#0d6efd,#20c997);color:#fff;border:none;border-radius:.6rem;font-weight:bold;font-size:.95rem;cursor:pointer;transition:all .2s}
    button:hover{transform:scale(1.05);box-shadow:0 6px 18px rgba(0,123,255,.25)}

    .btn-filters{background:#fff;border:1px solid #ced4da;color:#495057}
    .btn-filters:hover{background:#f8f9fa;color:#343a40}

    .modal .close{background:transparent!important;border:0!important;box-shadow:none!important;color:#6c757d!important;padding:.5rem 1rem!important;border-radius:.25rem!important}
    .modal .close:hover{color:#343a40!important;background:transparent!important}

    .tabla-responsive{overflow-x:auto;border-radius:.9rem}
    table{width:100%;border-collapse:separate;border-spacing:0;background-color:#fff;border-radius:.9rem;overflow:hidden;box-shadow:0 0 15px rgba(0,0,0,.05);font-size:.85rem}
    th,td{padding:10px 14px;text-align:center;border-bottom:1px solid #eee;vertical-align:middle;white-space:nowrap}
    th{background-color:#f8f9fa;color:#222;font-weight:700;font-size:.9rem}
    td{color:#444;font-size:.85rem}
    tr:hover{background-color:#f9fafc}

    .pagination-bar{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin:8px 0 14px}
    .pagination-bar .page-btn{background:#f1f3f5;color:#333}

    .btn-icon{background:transparent;border:none;padding:6px;line-height:1;border-radius:6px;cursor:pointer}
    .btn-icon:hover{background:rgba(0,0,0,.05)}
    .btn-icon i{font-size:1.05rem;color:#0d6efd}

    .seg-pill{border:1px solid #CFD8DC;color:#6c757d;cursor:pointer;padding:.35rem .6rem;border-radius:.5rem}
    .seg-pill.active{background:#304FFE;color:#fff;border-color:#304FFE}

    @media (max-width:768px){table{display:none}}
  </style>
</head>

<body>
  <div class="main-container">
    <div class="logo-container">
      <img src="/assets/logoglass.png" alt="Logo">
    </div>

    <h2>Gestión de Pedidos</h2>

    <div style="text-align:right;">
      <button id="logoutBtn"><i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión</button>
    </div>

    <!-- Panel Admin -->
    <div id="adminPanel" style="display:none;margin-top:20px;">
      <h3>Nuevo Pedido</h3>
      <form id="formNuevoPedido">
        <input type="text" id="numero_pedido" placeholder="Número de pedido" required>
        <input type="date" id="fecha_entrega" required>
        <button type="submit"><i class="bi bi-plus-circle me-1"></i> Crear</button>
      </form>
    </div>

    <h3>Pedidos registrados</h3>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div class="mb-2">
        <label for="filtroCompletado" class="font-weight-bold mb-0 mr-2">Filtrar pedidos:</label>
        <select id="filtroCompletado">
          <option value="todos">Todos</option>
          <option value="true">Completados</option>
          <option value="false">Pendientes</option>
        </select>
      </div>

      <div class="d-flex align-items-center mb-2">
        <button id="btnOpenFilters" class="btn btn-filters btn-sm mr-3">
          <i class="bi bi-funnel mr-1"></i> Filtros avanzados
        </button>
        <div class="mr-3">
          <input type="checkbox" id="chkPaginar">
          <label for="chkPaginar" class="mb-0">Paginar</label>
          <select id="pageSize" style="display:none;">
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
        <span id="totalInfo" class="text-muted mr-3">0 registros</span>
        <button id="btnEliminarCompletados" style="display:none;" class="btn btn-danger btn-sm mr-2">
          <i class="bi bi-trash-fill mr-1"></i> Eliminar completados
        </button>
        <button id="btnExportarPDF" class="btn btn-primary btn-sm">
          <i class="bi bi-download mr-1"></i> Descargar PDF
        </button>
      </div>
    </div>

    <div class="pagination-bar" id="paginationBar" style="display:none;">
      <button class="page-btn btn btn-light btn-sm" id="btnPrev">« Anterior</button>
      <span class="page-info mx-2" id="pageInfo">Página 1 de 1</span>
      <button class="page-btn btn btn-light btn-sm" id="btnNext">Siguiente »</button>
    </div>

    <div class="tabla-responsive">
      <table id="tablaPedidos">
        <thead>
          <tr>
            <th>ID</th>
            <th>Número</th>
            <th>Fecha de Creación</th>
            <th>Fecha de Entrega</th>
            <th>Ventas</th>
            <th>Contabilidad</th>
            <th>Producción</th>
            <th>Actualizar</th>
            <th>Comentarios</th>
            <th>Notificación</th>
            <th id="thEliminar" class="col-eliminar">Eliminar</th>
          </tr>
        </thead>
        <tbody id="cuerpoTabla"></tbody>
      </table>
    </div>

    <div id="cuerpoCards"></div>
  </div>

  <!-- Modal: Filtros -->
  <div class="modal fade" id="filtersModal" tabindex="-1" role="dialog" aria-labelledby="filtersLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="filtersLabel" class="modal-title" style="color:#495057;">Búsqueda y filtros avanzados</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <!-- Creación -->
          <div class="mb-3">
            <h6 class="mb-2"><span class="fa fa-calendar mr-2"></span>Fecha de creación</h6>
            <div class="d-flex flex-wrap mb-2">
              <div class="seg-pill mr-2 mb-2" data-mode="any" data-group="creacion">Cualquiera</div>
              <div class="seg-pill mr-2 mb-2 active" data-mode="specific" data-group="creacion">Específica</div>
              <div class="seg-pill mr-2 mb-2" data-mode="after" data-group="creacion">Después de</div>
              <div class="seg-pill mr-2 mb-2" data-mode="before" data-group="creacion">Antes de</div>
              <div class="seg-pill mr-2 mb-2" data-mode="between" data-group="creacion">Entre</div>
            </div>
            <div class="form-row">
              <div class="col-md-6 mb-2"><input type="date" id="fCreacionDesde" /></div>
              <div class="col-md-6 mb-2" id="wrapCreacionHasta"><input type="date" id="fCreacionHasta" /></div>
            </div>
          </div>

          <!-- Entrega -->
          <div class="mb-3">
            <h6 class="mb-2"><span class="fa fa-calendar mr-2"></span>Fecha de entrega</h6>
            <div class="d-flex flex-wrap mb-2">
              <div class="seg-pill mr-2 mb-2" data-mode="any" data-group="entrega">Cualquiera</div>
              <div class="seg-pill mr-2 mb-2 active" data-mode="specific" data-group="entrega">Específica</div>
              <div class="seg-pill mr-2 mb-2" data-mode="after" data-group="entrega">Después de</div>
              <div class="seg-pill mr-2 mb-2" data-mode="before" data-group="entrega">Antes de</div>
              <div class="seg-pill mr-2 mb-2" data-mode="between" data-group="entrega">Entre</div>
            </div>
            <div class="form-row">
              <div class="col-md-6 mb-2"><input type="date" id="fEntregaDesde" /></div>
              <div class="col-md-6 mb-2" id="wrapEntregaHasta"><input type="date" id="fEntregaHasta" /></div>
            </div>
          </div>

          <!-- Número / Estatus -->
          <div class="form-row">
            <div class="col-md-4 mb-2">
              <label class="font-weight-bold mb-1">Número</label>
              <input type="text" id="fNumero" placeholder="GC-0001..." />
            </div>
            <div class="col-md-4 mb-2">
              <label class="font-weight-bold mb-1">Departamento</label>
              <select id="fDepartamento">
                <option value="todos" selected>Todos</option>
                <option value="ventas">Ventas</option>
                <option value="contabilidad">Contabilidad</option>
                <option value="produccion">Producción</option>
              </select>
            </div>
            <div class="col-md-4 mb-2">
              <label class="font-weight-bold mb-1">Estatus (del depto)</label>
              <select id="fEstatus">
                <option value="todos" selected>Todos</option>
                <option value="pendiente">Pendiente</option>
                <option value="en proceso">En proceso</option>
                <option value="completado">Completado</option>
                <option value="sin estatus">Sin estatus</option>
              </select>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button id="btnLimpiarFiltros" type="button" class="btn btn-light">Limpiar filtros</button>
          <button id="btnAplicarFiltros" type="button" class="btn btn-success" data-dismiss="modal">
            <i class="bi bi-filter"></i> Aplicar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Comentarios -->
  <div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="commentLabel" class="modal-title">Comentarios del pedido</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label class="font-weight-bold">Comentarios anteriores</label>
          <textarea id="comentarioTexto" readonly rows="6" class="form-control mb-3" style="background:#f8f9fa;"></textarea>
          <label class="font-weight-bold">Tu comentario</label>
          <textarea id="nuevoComentario" rows="4" class="form-control" placeholder="Escribe o edita tu comentario..."></textarea>
        </div>
        <div class="modal-footer">
          <button id="eliminarComentario" type="button" class="btn btn-danger">🗑 Eliminar</button>
          <button id="guardarComentario" type="button" class="btn btn-success">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- App -->
  <script type="module" src="/js/index.js?v=v2025-08-19-4"></script>

  <!-- Service Worker con versión -->
  <script>
    (function() {
      if (!('serviceWorker' in navigator)) return;
      const SW_VERSION_TAG = 'v2025-08-19-4';
      const swUrl = `/service-worker.js?v=${encodeURIComponent(SW_VERSION_TAG)}`;
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register(swUrl, { scope: '/', updateViaCache: 'none' });
          reg.update();
          if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return; refreshing = true; window.location.reload();
          });
          setInterval(() => reg.update(), 30 * 60 * 1000);
        } catch (e) { console.error('SW registro falló:', e); }
      });
    })();
  </script>
</body>
</html>
